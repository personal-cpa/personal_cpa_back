# 계정과목 관리 기능 기획서 (보충판)

## 1. 개요

### 1.1 배경
- 개인 복식부기 가계부 서비스에서 모든 거래(트랜잭션)는 ‘계정과목’을 기준으로 차변·대변으로 분개된다.
- 계정과목(Chart of Accounts)은 자산, 부채, 자본, 수익, 비용 등 5대 회계 범주 하위에 다양한 계정을 두어 체계적으로 분류하는 핵심 요소이다.
- 특히, 주식·코인·부동산·예금 등 **투자 자산**을 세밀하게 관리하기 위해, **부모 계정**과 **자식 계정**의 트리 구조(예: 자산 → 주식 → 국내 주식 / 해외 주식 → 계좌별)로 구성할 수 있다.
- 프로젝트 확장(주식·코인·부동산, 해외 주식, 세무처리 등)을 위해서는 유연하고 확장성 있는 계정과목 구조가 필수적이다.

### 1.2 목적
- 복식부기의 근간이 되는 **계정과목(Chart of Accounts)**을 정의·관리하고, 이를 통해 **거래 입력** 시 계정을 손쉽게 선택하고 재무제표(대차대조표·손익계산서 등)를 자동 생성할 수 있게 한다.
- 자산/부채/자본/수익/비용에 대한 **체계적 관리**로 **시세 변동**, **투자 포트폴리오 집계**, **보고서** 등 다양한 분석을 지원한다.
- **부모-자식** 계정 구조를 활용해, 자산을 대분류(주식/코인/부동산 등), 중분류(국내 주식/해외 주식), 소분류(각 계좌별) 등으로 **유연하게 분류**할 수 있다.

---

## 2. 범위 및 목표

1. **계정과목 생성(Create)**: 사용자가 새 계정을 등록(코드, 이름, 유형 등)
2. **조회(Read)**: 등록된 계정 목록, 특정 계정 상세정보, 계정 검색/필터
3. **수정(Update)**: 계정명, 설명, 숨김 여부, 부모 계정 변경 등
4. **삭제(Delete/Deactivate)**: 잘못 생성된 계정 삭제 혹은 비활성화 처리
5. **유효성 검사**:
    - 중복 코드·이름 방지
    - 이미 거래가 기록된 계정의 `type`/`code` 등 핵심 속성 변경 제한
6. **부모-자식 트리 구조 지원**:
    - 예: **자산(ASSET)** → **주식** → “국내 주식” → “국내 주식 계좌1” …
    - 보고서나 UI에서 그룹별로 합산·집계 가능
7. **관리UI/화면**: 사용자 입장에서 계정 생성·수정·삭제를 직관적으로 수행
8. **API 연동**: 추후 거래 입력, 시세 업데이트 등에 연계

---

## 3. 정의 및 용어

- **계정과목(Account)**: 복식부기에서 거래를 분류·기록하기 위한 항목. 예) 현금, 예금, 카드대금, 부채, 수익(월급·배당 등), 비용(생활비 등).
- **계정 유형(Type)**: 자산(ASSET), 부채(LIABILITY), 자본(EQUITY), 수익(REVENUE), 비용(EXPENSE) 등.
- **부모 계정(Parent Account)**: 중분류·대분류 역할을 수행할 상위 계정. 해당 계정 아래 여러 자식 계정을 둬서 트리 구조로 관리 가능.
- **계정 코드(Code)**: 회계적 표준 또는 내부 규칙에 따라 부여하는 식별자(예: 101, 201-01 등).
- **user_id**: (선택) 멀티 사용자 시나리오를 대비해, 계정과목이 어떤 사용자 소속인지 구분하기 위해 추가할 수 있는 필드.

---

## 4. 요구사항

### 4.1 기능 요구사항 (FR)

1. **계정 생성**
    - [FR-1] 사용자는 **계정명, 계정 타입, 코드, 설명, 부모 계정, 숨김 여부** 등을 입력하여 새 계정을 등록할 수 있다.
    - [FR-2] 코드나 이름이 중복될 경우 시스템은 오류를 반환한다.

2. **계정 목록 조회**
    - [FR-3] 사용자는 모든 계정 목록을 확인할 수 있다.
    - [FR-4] 계정 타입(자산·부채·자본·수익·비용)이나 활성 여부 등으로 필터링할 수 있다.
    - [FR-5] 부모-자식 구조를 트리 형태로 보여주거나, 계층 정보(레벨/parent_id)를 제공해 프론트에서 트리로 표현할 수 있어야 한다.

3. **계정 상세 조회**
    - [FR-6] 특정 계정 ID로 상세 정보를 조회할 수 있다.
    - [FR-7] 상세 정보에는 계정 타입, 코드, 설명, 현재 활성 상태, 부모 계정, 생성일·수정일 등이 포함된다.

4. **계정 수정**
    - [FR-8] 계정명, 설명, 숨김 여부, (필요 시) `parent_account_id` 등을 수정할 수 있다.
    - [FR-9] 이미 거래가 발생한 계정의 유형(type)·코드(code) 변경 시, 시스템이 제한하거나 경고해줘야 한다(회계 무결성).

5. **계정 삭제 혹은 비활성화**
    - [FR-10] 거래가 없는 계정은 물리 삭제(physical delete)가 허용된다.
    - [FR-11] 거래가 있는 계정은 ‘비활성화(soft-delete, isHidden)’ 기능만 제공해 사용자 화면에서 숨길 수 있다.
    - [FR-12] 비활성 계정도 과거 거래내역에는 영향을 주지 않는다(새 거래 시에는 선택 불가).

6. **트리 구조 연동**
    - [FR-13] “주식” 같은 상위 계정 아래에 “국내 주식”, “해외 주식” 등을 두고, 그 아래 또 세부 계좌를 두는 다단계 구조가 가능해야 한다.
    - [FR-14] 보고서나 UI에서 상위 계정별로 금액 합산을 쉽게 할 수 있는 구조를 지원한다.

7. **UI/UX**
    - [FR-15] 계정 관리 페이지에서 계정 생성·수정·삭제(비활성화) 기능을 제공하며, 트리 뷰나 계층적 UI를 통해 쉽게 관리 가능하도록 한다.
    - [FR-16] 거래 입력 화면에서 계정을 검색·필터링하여 선택 가능하게 한다(계정 목록 API 연동).

### 4.2 비기능 요구사항 (NFR)

1. **보안** (점진적 도입)
    - [NFR-1] 초기에는 사용자 1인 시나리오라 간단히 시작하되, 필요 시 JWT/OAuth 등 인증 방식을 나중에 붙인다.
    - [NFR-2] 멀티 사용자로 확장 시, user_id를 두어 각 사용자의 계정 데이터를 구분하고, 인증 토큰으로 권한을 검사할 수 있게 한다.

2. **성능**
    - [NFR-3] 계정이 많아져도(수백~수천 건) 빠르게 조회·정렬·트리 렌더링이 가능해야 한다.

3. **확장성**
    - [NFR-4] 타입(enum)에는 ASSET, LIABILITY 등 최소 5대 범주를 쓰되, 필요 시 추가 항목(예: 임시 계정 유형)을 늘릴 수 있도록 코드·DB 스키마를 설계한다.
    - [NFR-5] (애자일) 나중에 다국어(계정명 번역)·다통화(예: 해외 주식 달러 계좌) 등 확장도 고려.

4. **로그/감사**
    - [NFR-6] 계정 생성·수정·삭제 이력을 로깅하여, 언제 누가 어떤 작업을 했는지 추적할 수 있어야 한다(개인용이긴 하지만, 추후 팀원과 공유 시 필요할 수 있음).

---

## 5. 기능 상세 시나리오

### 5.1 계정 생성 (Create)

1. 사용자가 ‘계정 생성’ 버튼 클릭
2. `name, type, code, description, parent_account_id, isHidden(기본 false)` 등을 입력
3. 유효성 검사(필수 필드, 중복 코드, 오타 방지) 후 DB 저장
4. 성공 시 “계정이 성공적으로 생성되었습니다.” 메시지 표시
5. 예시 구조
    - **자산(ASSET)** → **주식(ASSET)** → “국내 주식(ASSET)” → “국내 주식 계좌1” …

### 5.2 계정 목록 조회 (Read - List)

1. 사용자가 ‘계정 목록’ 페이지 접속
2. DB에서 모든 계정을 가져와 **트리 구조**(parent-child 관계)로 정렬
3. “숨김 계정”은 기본적으로 노출 안 하되, “숨김 계정 보기” 옵션 활성 시 노출
4. 검색창/필터로 계정명·코드·타입 검색

### 5.3 계정 상세 조회 (Read - Detail)

1. 사용자가 특정 계정을 선택
2. 시스템은 `GET /chart_of_accounts/{id}` API로 세부 정보를 가져옴
3. 화면에 계정명, 코드, type, parent_account, isHidden, created_at, updated_at 등 표시
4. 필요 시 상위 계정/하위 계정을 함께 표시(트리 탐색)

### 5.4 계정 수정 (Update)

1. 사용자가 ‘수정’ 버튼 클릭
2. 변경할 필드를 입력(이름, 설명, parent_account_id, isHidden 등)
3. 거래가 있는 계정의 `type`·`code` 변경은 제한(경고창 또는 불가)
4. 성공 시 DB 반영 후 화면 갱신

### 5.5 계정 삭제·비활성화 (Delete/Deactivate)

1. 사용자가 ‘삭제’ 또는 ‘비활성화’ 버튼 클릭
2. DB에서 해당 계정 거래 유무 확인
    - 거래 없는 계정: 물리 삭제
    - 거래 있는 계정: `isHidden=true` 또는 `deleted_at=timestamp`로 soft-delete
3. 사용자 화면에 처리 결과 표시

### 5.6 트리 구조 활용 예시

- **주식**(부모 계정) → **국내 주식**(자식) → “국내 주식 계좌1” …
- **주식**(부모 계정) → **해외 주식**(자식) → “해외 주식 계좌1”, “해외 주식 계좌2”…
- 보고서에서 “주식” 계정의 합계를 구하면, 모든 국내·해외 주식 계좌 자식들의 잔액을 합산하여 나타낼 수 있다.

---

## 6. 데이터 모델 / DB 설계

### 6.1 테이블 예시: `chart_of_accounts`

| 필드명           | 자료형       | 설명                                                                                                            |
|------------------|-------------|-----------------------------------------------------------------------------------------------------------------|
| id (PK)          | INT         | Primary Key, Auto Increment                                                                                     |
| user_id (선택)   | INT (FK)    | (멀티 유저 대비) 어느 사용자의 계정인지 구분. 1인용이라면 고정값이라도 향후 확장성 위해 컬럼 두는 것 고려 가능.  |
| name             | VARCHAR     | 계정명 (예: “주식”, “해외 주식”, “해외 주식 계좌1” 등)                                                            |
| code             | VARCHAR     | 계정 코드(예: “101”, “101-01”)                                                                                  |
| type             | ENUM/VARCHAR| ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE 등. 문자열/숫자 중 프로젝트 선호도에 따라 선택                       |
| parent_account_id| INT (FK)    | 상위 계정 FK (NULL이면 최상위)                                                                                   |
| is_hidden        | BOOLEAN     | 숨김 여부 (기본 false)                                                                                          |
| description      | TEXT        | 계정 설명(예: “해외 주식용 계좌, 달러로 거래” 등)                                                                |
| created_at       | DATETIME    | 생성 일시                                                                                                       |
| updated_at       | DATETIME    | 수정 일시                                                                                                       |
| deleted_at       | DATETIME    | 삭제 일시(soft-delete 시)                                                                                        |

- 이 구조를 통해, “주식” 계정이 `parent_account_id = (자산의 id)`를 참조하고, “해외 주식”이 다시 `parent_account_id = (주식의 id)`를 참조하는 식으로 트리 구성.

---

## 7. API/인터페이스 설계

### 7.1 엔드포인트 목록 (예시, RESTful)

> 초기에는 인증 없이(1인용) 개발 → 이후 **JWT/세션 인증** 등 점진 도입

1. **POST /chart_of_accounts**
    - 내용: 계정과목 생성
    - 요청 바디 예시:
      ```json
      {
        "name": "주식",
        "code": "101-02",
        "type": "ASSET",
        "description": "주식 계정",
        "parentAccountId": 1, // 자산(ASSET)의 ID
        "isHidden": false
      }
      ```
    - 응답: 생성된 계정 정보

2. **GET /chart_of_accounts**
    - 내용: 계정과목 목록 조회
    - 쿼리 파라미터: `type=ASSET`, `includeHidden=true/false`, `search=“국내”` 등
    - 응답: JSON Array로 **트리 구조**(혹은 부모-자식 id 관계) 표현

3. **GET /chart_of_accounts/{id}**
    - 내용: 단일 계정과목 상세 조회
    - 응답: 계정명, 코드, type, parentAccountId, isHidden 등 상세 정보

4. **PUT /chart_of_accounts/{id}**
    - 내용: 계정과목 수정
    - 요청 바디 예시:
      ```json
      {
        "name": "국내 주식 계좌1",
        "description": "메인 국내 주식 계좌",
        "parentAccountId": 2, // 주식(부모) 계정 id
        "isHidden": false
      }
      ```

5. **DELETE /chart_of_accounts/{id}**
    - 내용: 계정과목 삭제(또는 비활성화)
    - 거래 유무에 따라 soft-delete vs. physical delete 결정

### 7.2 에러 처리

- **400 Bad Request**: 필수 필드 누락, 중복 코드, 잘못된 type 값 등
- **404 Not Found**: 존재하지 않는 계정 ID
- **409 Conflict**: 이미 거래가 있는 계정의 `type`/`code`를 변경하려 할 때, 혹은 상위 계정이 자기 자신을 자식으로 삼으려는 경우(트리 구조 충돌) 등

---

## 8. UI/UX 시안 (보충)

1. **계정 목록 (트리 뷰)**
    - **자산(ASSET)**
        - 주식
            - 국내 주식
                - 국내 주식 계좌1
                - 국내 주식 계좌2
            - 해외 주식
                - 해외 주식 계좌1
        - 코인
            - 코인지갑1
            - 코인지갑2
        - 예금
            - 우리은행 계좌
            - KB은행 계좌
    - **부채(LIABILITY)**
        - 주택담보대출
        - 신용카드 결제대금
    - …

2. **계정 생성/수정 모달**
    - `name`, `code`, `type`, `parentAccount`(드롭다운), `isHidden`(체크박스)
    - “저장” 시 유효성 검사 → “계정이 생성되었습니다.”

3. **계정 상세 페이지**
    - 상위 계정(부모) / 하위 계정(자식) 목록 표기
    - “수정”, “삭제(또는 비활성화)” 버튼

---

## 9. 보안·권한 (보충)

- **현재**: 1인용 시나리오이므로, 사실상 사용자가 전권을 가진다. 인증 절차 없이도 기본 기능을 사용 가능.
- **추후**: 멀티 사용자로 확장 시, `user_id` 컬럼 도입(혹은 활성화)하여 각 사용자의 계정과목을 구분.
    - JWT/세션 로그인 시, 요청한 user_id가 해당 계정과목 소유자인지 확인(Authorization) 필요.
    - 실제로는 DB에 기본적으로 `user_id` 필드를 추가해두는 경우가 많음(ALTER TABLE 최소화).

---

## 10. 일정 및 마일스톤

| 단계                | 기간           | 작업 항목                                                                  |
|---------------------|---------------|---------------------------------------------------------------------------|
| 요구사항 확정        | 1주차          | - 기능 목록 합의 <br> - 부모-자식 트리 구조, user_id 필드 사용 여부 논의 |
| 설계/DB 스키마 작성 | 2주차          | - API 명세 <br> - ERD(계정과목, 거래) <br> - UI 와이어프레임 작성        |
| 개발/구현           | 3~4주차        | - 백엔드: 엔드포인트 구현, 트리 구조 로직 <br> - 프론트: 트리 뷰 UI     |
| 테스트/검증         | 5주차          | - 유닛 테스트, 통합 테스트 <br> - 트리 구조 에지 케이스(순환 참조 등)   |
| 초기 배포           | 6주차          | - MVP 프로덕션 배포 <br> - 사용자 피드백 수렴                             |
| 보안 확장           | 이후 스프린트  | - 로그인/세션/JWT 도입 <br> - 다인용/멀티 유저 시나리오 대비             |

---

## 11. QA / 테스트 시나리오

1. **계정 생성**
    - 정상 입력: 중복 없는 코드/이름 → 계정 생성 성공, 트리 뷰 반영
    - 오류 입력: 부모 계정이 존재하지 않는 id, 중복 코드, type 잘못 기입 등
2. **부모-자식 구조**
    - “자산 → 주식 → 국내 주식 → 계좌1” 식으로 계층 생성 후 목록 조회 → 트리 뷰 확인
    - 순환 참조 방지(자식이 부모가 되도록 설정하면 에러 반환)
3. **계정 수정**
    - 이미 거래 기록이 있는 계정의 `code` 변경 시도 → 제한/경고 메시지
    - parent_account 변경으로 트리 이동 → 정상 반영/트리 갱신
4. **계정 삭제**
    - 거래가 없는 계정 → 물리 삭제 OK
    - 거래가 있는 계정 → soft-delete(숨김) 처리
5. **검색/필터**
    - “type=ASSET” 검색 → 자산 계정만 노출
    - “includeHidden=true” 시 숨김 계정도 리스트에 표시
6. **보안(추후)**
    - 로그인 없이도 작업 가능(현재 1인용)
    - 나중에 JWT/세션 붙이면서 user_id 소유권 확인 테스트

---

# 결론 및 요약

- 본 기획서는 **계정과목(Chart of Accounts) 관리 기능**에 “부모-자식 트리 구조”를 적용하는 보충 사항을 포함한다.
- **주식, 코인, 예금** 등 자산 계정에 대해 상위-하위 계정을 자유롭게 배치해 **세분화**하고, 보고서나 UI에서 **그룹 합산**과 **세부 관리**를 지원한다.
- 1인용 MVP를 빠르게 구현한 뒤, **점진적(애자일) 접근**으로 로그인/보안, 멀티 사용자 모드를 차차 도입할 예정이다.
- DB 스키마 설계 시 `user_id`를 미리 두어 **멀티 유저 확장**을 대비할 수 있으며, 계정 유형(`type`)은 문자열 enum(ASSET/LIABILITY/…)을 사용하는 방식을 권장한다.

이로써 **주식 하위에 국내/해외 주식 계좌를 나누는 예시** 등 다양한 계층 분류가 가능해져, 복식부기 기반 개인 가계부가 **보다 체계적**으로 자산·부채·수익·비용을 관리할 수 있게 된다.